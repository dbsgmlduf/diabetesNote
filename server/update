from flask import Flask, request, jsonify
import mysql.connector
from mysql.connector import Error

app = Flask(__name__)

def update_bloodsugar(user_no, new_blood_sugar, measure_date, db_name):
    try:
        connection = mysql.connector.connect(
            host='localhost',
            database= 'sugar_note',
            user='root',
            password='010319'
        )

        if connection.is_connected():
            cursor = connection.cursor()

            # bloodsugar 테이블 업데이트
            update_query = """
            UPDATE bloodsugar
            SET blood_sugar = %s, mesure_date = %s
            WHERE user_no = %s
            """
            update_data = (new_blood_sugar, measure_date, user_no)

            cursor.execute(update_query, update_data)
            connection.commit()

            print(f"user_no {user_no}의 정보 업데이트 완료")
            return True

    except Error as e:
        print("MySQL 연결 오류:", e)
        return False

    finally:
        if 'cursor' in locals() and cursor is not None:
            cursor.close()
        if 'connection' in locals() and connection.is_connected():
            connection.close()
            print("MySQL 연결 종료")

def delete_bloodsugar(user_no, measure_date, db_name):
    try:
        connection = mysql.connector.connect(
            host='localhost',
            database=db_name,
            user='root',
            password='010319'
        )

        if connection.is_connected():
            cursor = connection.cursor()

            # bloodsugar 테이블 데이터 삭제
            delete_query = """
            DELETE FROM bloodsugar
            WHERE user_no = %s AND mesure_date = %s
            """
            delete_data = (user_no, measure_date)

            cursor.execute(delete_query, delete_data)
            connection.commit()

            print(f"user_no {user_no}, measure_date {measure_date}의 정보 삭제 완료")
            return True

    except Error as e:
        print("MySQL 연결 오류:", e)
        return False

    finally:
        if 'cursor' in locals() and cursor is not None:
            cursor.close()
        if 'connection' in locals() and connection.is_connected():
            connection.close()
            print("MySQL 연결 종료")

@app.route('/update_bloodsugar', methods=['POST'])
def update_bloodsugar_endpoint():
    try:
        data = request.get_json()
        user_no = data['user_no']
        new_blood_sugar = data['new_blood_sugar']
        measure_date = data['measure_date']
        db_name = 'sugar_note'  # 데이터베이스 이름을 여기서 설정

        if update_bloodsugar(user_no, new_blood_sugar, measure_date, db_name):
            return jsonify({'message': '혈당 정보 업데이트 성공'})
        else:
            return jsonify({'message': '혈당 정보 업데이트 실패'}), 500

    except Exception as e:
        return jsonify({'message': '요청 처리 중 오류 발생', 'error': str(e)}), 500

@app.route('/delete_bloodsugar', methods=['DELETE'])
def delete_bloodsugar_endpoint():
    try:
        data = request.get_json()
        user_no = data['user_no']
        measure_date = data['measure_date']
        db_name = 'sugar_note'  # 데이터베이스 이름을 여기서 설정

        if delete_bloodsugar(user_no, measure_date, db_name):
            return jsonify({'message': '혈당 정보 삭제 성공'})
        else:
            return jsonify({'message': '혈당 정보 삭제 실패'}), 500

    except Exception as e:
        return jsonify({'message': '요청 처리 중 오류 발생', 'error': str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True)
